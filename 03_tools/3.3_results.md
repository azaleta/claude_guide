# 3.3 处理工具调用结果

当 Claude 决定使用工具时，会返回一个工具调用请求。你需要执行工具并将结果返回给 Claude。

---

## 响应结构

Claude 的工具调用响应：

```json
{
  "stop_reason": "tool_use",
  "content": [
    {
      "type": "tool_use",
      "id": "toolu_01ABC123",
      "name": "get_weather",
      "input": {
        "city": "北京"
      }
    }
  ]
}
```

---

## 处理流程

```python
# 1. 检查是否需要工具调用
if response.stop_reason == "tool_use":
    # 2. 提取工具调用信息
    tool_use = next(
        block for block in response.content 
        if block.type == "tool_use"
    )
    
    # 3. 执行工具
    result = execute_tool(tool_use.name, tool_use.input)
    
    # 4. 将结果发送回 Claude
    follow_up = client.messages.create(
        model="claude-sonnet-4-20250514",
        max_tokens=1024,
        tools=tools,
        messages=[
            {"role": "user", "content": original_query},
            {"role": "assistant", "content": response.content},
            {
                "role": "user",
                "content": [{
                    "type": "tool_result",
                    "tool_use_id": tool_use.id,
                    "content": json.dumps(result)
                }]
            }
        ]
    )
```

---

## 错误处理

工具执行失败时，返回错误信息：

```python
{
    "type": "tool_result",
    "tool_use_id": tool_use.id,
    "content": "错误：无法连接到天气服务",
    "is_error": True
}
```

---

## 小结

- 检测 `stop_reason == "tool_use"` 判断是否需要工具调用
- 执行工具后，将结果作为 `tool_result` 返回
- 错误时设置 `is_error: True`
