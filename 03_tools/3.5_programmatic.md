# 3.5 高级特性：程序化工具调用

2025 年末，Anthropic 发布了高级工具特性：程序化工具调用，使调动多个工具更高效。

---

## 程序化工具调用 (Programmatic Tool Calling)

程序化工具调用允许 Claude **编写代码**并在**代码执行容器**中以编程方式调用你的工具，而不是每次调用工具都需要在模型和应用之间进行往返。

### 核心优势

-   **降低延迟**：对于涉及多个工具调用的复杂工作流，Claude 可以在一次响应中完成所有逻辑编排，无需在每个工具调用点停下来等待客户端返回结果。
-   **节省 Token**：Claude 可以在代码容器内对工具返回的大量原始数据进行预处理、过滤或总结（例如查询数据库后只提取关键字段），从而减少注入到模型上下文窗口的数据量。
-   **复杂逻辑编排**：支持在代码中使用循环、条件判断等逻辑来动态决定如何组合使用不同的工具。

### 工作模式对比

| 特性 | 传统工具调用 (Standard) | 程序化工具调用 (Programmatic) |
| :--- | :--- | :--- |
| **交互方式** | 令牌往返 (Model ↔ Client) | Claude 生成并运行 Python 代码 |
| **执行位置** | 客户端（你的应用） | 代码执行容器 |
| **多次调用** | 每次调用需一个 Model Turn | 单个 Model Turn 可完成多次调用 |
| **数据处理** | 全部返回给模型 | 在容器内进行过滤/处理 |

```python
# 程序化方式示例：Claude 生成的代码在容器内运行
def process_task():
    raw_data = tools.fetch_data(api_key="...")
    # 在容器内进行预处理，只有处理后的结果才进入上下文
    filtered_data = [d for d in raw_data if d['status'] == 'active']
    analysis = tools.analyze(filtered_data)
    return analysis
```

---

### 核心概念与配置

要在程序化环境中使用工具，需要在定义工具时使用 `allowed_callers` 字段：

-   `allowed_callers`: 指定谁可以调用该工具。
    -   `["direct"]`: 仅允许 Claude 直接调用（传统方式，默认值）。
    -   `["code_execution_20250825"]`: 仅允许在代码执行容器内调用。
    -   `["direct", "code_execution_20250825"]`: 两种方式均可。
-   **建议**：通常建议二选一，这能为 Claude 提供更清晰的使用指令。

### 容器生命周期管理

程序化工具调用复用了代码执行容器：
-   **创建**：每个会话默认创建一个新容器。
-   **有效期**：容器在闲置约 4.5 分钟后会过期。
-   **状态复用**：通过 `container` ID 可以跨请求保持状态。
-   **超时处理**：应用必须在容器过期前返回工具结果，否则 Claude 可能会重试调用。

### 响应格式要求

与传统工具调用不同，在响应程序化工具调用时有严格的格式限制：
-   **纯结果响应**：如果还有待处理的程序化工具调用，你的响应消息**必须仅包含** `tool_result` 块。
-   **禁止包含文本**：在返回程序化工具结果时，不能包含任何 `text` 内容，否则会报错。

### 限制与不兼容性

-   **功能不兼容**：
    -   不支持 `strict: true`（结构化输出）。
    -   不支持通过 `tool_choice` 强制指定调用某个工具。
    -   不支持 `disable_parallel_tool_use: true`。
-   **暂不支持的工具类型**：
    -   目前 `web_search`、`web_fetch` 以及通过 MCP 连接器提供的工具**不能**被程序化调用。

---


## 工具学习

通过示例教会 Claude 正确使用复杂工具：

```xml
<tool_examples>
  <example tool="complex_api">
    <task>查询用户订单</task>
    <correct_usage>
      complex_api(action="query", resource="orders", filter={"user_id": "..."})
    </correct_usage>
  </example>
</tool_examples>
```

---

## 最佳实践

| 建议 | 说明 |
|------|------|
| 工具数量控制 | 单次请求不超过 20 个工具定义 |
| 描述精确 | 清晰说明何时使用、何时不使用 |
| 错误处理 | 优雅处理工具失败情况 |
| 安全验证 | 验证 Claude 生成的参数 |

---

## 小结

- 程序化工具调用显著减少了复杂工作流中的 API 往返
- 通过容器内预处理节省 Token 并降低模型处理负担
- 开发者需要严格遵循程序化调用的响应格式要求

下一节将详细介绍如何 [管理大型工具库：工具搜索](3.6_tool_search.md)。
