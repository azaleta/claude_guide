# 3.6 工具搜索：管理大型工具库

当你的应用拥有数十个甚至上千个工具时，将所有工具定义一次性发送给模型会消耗大量的 Token，并可能降低模型选择正确工具的准确率。**工具搜索（Tool Search）** 特性允许 Claude 按需发现和加载工具，从而高效地管理大规模工具库。

---

## 工作机制：延迟加载

工具搜索的核心思想是**延迟加载（Deferred Loading）**。

1.  **标记工具**：在定义工具时，将不常用或数量庞大的工具标记为 `defer_loading: true`。
2.  **初始状态**：Claude 初始只能看到标记为立即加载的少量核心工具和“工具搜索工具”。
3.  **触发搜索**：当任务需要更多能力时，Claude 会调用工具搜索工具（通过关键词或正则）。
4.  **动态发现**：系统返回最相关的 3-5 个工具定义，Claude 随后选择并调用它们。

---

## 搜索变体

Anthropic 提供了两种内置的搜索变体：

### 1. 正则搜索 (Regex Variant)
Claude 通过构造 Python 正则表达式模式来查找工具。
-   **类型 ID**: `tool_search_tool_regex_20251119`
-   **适用场景**: Claude 对工具命名规范有预期（如 `get_.*_data`），或者需要精确匹配。
-   **示例模式**: `"weather"`, `"(?i)slack"` (不区分大小写), `"database.*query"`.

### 2. 内容搜索 (BM25 Variant)
Claude 通过自然语言查询来搜索工具。
-   **类型 ID**: `tool_search_tool_bm25_20251119`
-   **适用场景**: 工具描述更具有语义化，通过功能描述来匹配最合适的能力。

---

## 定义示例

```json
{
  "tools": [
    {
      "type": "tool_search_tool_bm25_20251119",
      "name": "search_tools"
    },
    {
      "name": "get_weather",
      "description": "获取指定城市的当前天气",
      "input_schema": { ... },
      "defer_loading": true 
    }
  ]
}
```

> 💡 **核心提示**：工具搜索工具本身**不能**设置 `defer_loading: true`，否则模型无法发现它。

---

## 最佳实践与限制

### 适用场景
-   **工具数量多**：通常超过 10 个工具时开始显现优势。
-   **庞大的定义**：单个工具定义非常复杂，导致 Token 消耗过大。
-   **MCP 集成**：当连接多个 MCP 服务器（可能有成百上千工具）时，这是必选项。

### 优化建议
-   **保留核心**：保持 3-5 个最常用的工具为立即加载。
-   **描述清晰**：工具的名称和描述必须准确，以便搜索匹配。
-   **系统提示**：在系统提示词中告知 Claude 可用的工具类别，例如：“你可以搜索用于 GitHub、Jira 和 Slack 的工具”。

### 限制
-   **模型支持**：目前仅支持 Claude 3.5 Sonnet 及更高版本（不支持 Haiku）。
-   **目录上限**：支持高达 10,000 个工具的目录。
-   **查询长度**：搜索模式/关键词最大长度为 200 字符。

---

## 小结

-   工具搜索解决了大规模工具库的 Token 消耗和准确率权衡问题。
-   通过 `defer_loading` 实现按需加载。
-   内置支持正则（Regex）和语义（BM25）两种搜索方式。
-   是构建复杂 Agent 或集成多 MCP 服务器的关键特性。

随着工具的增多，新的问题出现了，工具如何能在生产环境中被安全、可控、规模化地执行？下一章将介绍的 [MCP 模型上下文协议](../04_mcp/README.md) 将提供一套优雅的方案。
